package com.veterinarska.stanica.controller;

import com.veterinarska.stanica.dto.MedicinskiZapisDTO;
import com.veterinarska.stanica.mapper.AppMapper;
import com.veterinarska.stanica.model.Korisnik;
import com.veterinarska.stanica.model.Ljubimac;
import com.veterinarska.stanica.model.MedicinskiZapis;
import com.veterinarska.stanica.model.Pregled;
import com.veterinarska.stanica.model.Uloga;
import com.veterinarska.stanica.repository.KorisnikRepository;
import com.veterinarska.stanica.repository.LjubimacRepository;
import com.veterinarska.stanica.repository.MedicinskiZapisRepository;
import com.veterinarska.stanica.repository.PregledRepository;
import org.springframework.http.ResponseEntity;
import org.springframework.security.core.Authentication;
import org.springframework.web.bind.annotation.*;

import java.time.format.DateTimeFormatter;
import java.util.ArrayList;
import java.util.Collections;
import java.util.Comparator;
import java.util.List;
import java.util.Locale;
import java.util.Map;
import java.util.HashMap;
import java.util.Objects;
import java.util.stream.Collectors;

import static com.veterinarska.stanica.mapper.AppMapper.toDTO;

@RestController
@RequestMapping("/api/medicinski-zapisi")
public class MedicinskiZapisController {

    private final MedicinskiZapisRepository zapisRepo;
    private final LjubimacRepository ljubimacRepo;
    private final KorisnikRepository korisnikRepo;
    private final PregledRepository pregledRepo;

    public MedicinskiZapisController(MedicinskiZapisRepository zapisRepo,
                                     LjubimacRepository ljubimacRepo,
                                     KorisnikRepository korisnikRepo,
                                     PregledRepository pregledRepo) {
        this.zapisRepo = zapisRepo;
        this.ljubimacRepo = ljubimacRepo;
        this.korisnikRepo = korisnikRepo;
        this.pregledRepo = pregledRepo;
    }

    // ---------- DTO za listu u dropdown-u ----------
    public static class EligibleItem {
        private Long pregledId;
        private String ljubimacIme;
        private String vlasnik;
        private String terminOpis;
        public EligibleItem() {}
        public EligibleItem(Long pregledId, String ljubimacIme, String vlasnik, String terminOpis) {
            this.pregledId = pregledId;
            this.ljubimacIme = ljubimacIme;
            this.vlasnik = vlasnik;
            this.terminOpis = terminOpis;
        }
        public Long getPregledId() { return pregledId; }
        public String getLjubimacIme() { return ljubimacIme; }
        public String getVlasnik() { return vlasnik; }
        public String getTerminOpis() { return terminOpis; }
        public void setPregledId(Long pregledId) { this.pregledId = pregledId; }
        public void setLjubimacIme(String ljubimacIme) { this.ljubimacIme = ljubimacIme; }
        public void setVlasnik(String vlasnik) { this.vlasnik = vlasnik; }
        public void setTerminOpis(String terminOpis) { this.terminOpis = terminOpis; }
    }

    // ---------- DTO za kreiranje zapisa (ulaz iz fronta) ----------
    public static class CreateRequest {
        private Long pregledId;     // preporučeno da front šalje iz padajuće liste (korisnik ne vidi ID)
        private String ljubimacIme; // fallback ako baš ne šalješ ID
        private String dijagnoza;   // obavezno
        private String terapija;    // opciono
        public Long getPregledId() { return pregledId; }
        public void setPregledId(Long pregledId) { this.pregledId = pregledId; }
        public String getLjubimacIme() { return ljubimacIme; }
        public void setLjubimacIme(String ljubimacIme) { this.ljubimacIme = ljubimacIme; }
        public String getDijagnoza() { return dijagnoza; }
        public void setDijagnoza(String dijagnoza) { this.dijagnoza = dijagnoza; }
        public String getTerapija() { return terapija; }
        public void setTerapija(String terapija) { this.terapija = terapija; }
    }

    // ---------- LISTANJE POSTOJEĆIH ZAPISA (nije menjano) ----------
    @GetMapping
    public ResponseEntity<List<MedicinskiZapisDTO>> svi() {
        List<MedicinskiZapisDTO> out = zapisRepo.findAll()
                .stream()
                .map(AppMapper::toDTO)
                .collect(Collectors.toList());
        return ResponseEntity.ok(out);
    }

    // ---------- LISTA ZA DDL: samo OBAVLJENI pregledi ovog veterinara ----------
    @GetMapping("/moji-ljubimci-za-izvestaj")
    public ResponseEntity<?> mojiLjubimciZaIzvestaj(Authentication auth) {
        Korisnik vet = ulogovanVeterinar(auth);
        if (vet == null) return ResponseEntity.status(401).body(singleMsg("Niste prijavljeni."));
        if (vet.getUloga() != Uloga.VETERINAR)
            return ResponseEntity.status(403).body(singleMsg("Samo veterinar može unositi medicinske zapise."));

        List<Pregled> pregledi = pregledRepo.findByVeterinarEmail(vet.getEmail());
        DateTimeFormatter fmt = DateTimeFormatter.ofPattern("dd.MM.yyyy. HH:mm");

        List<EligibleItem> out = new ArrayList<EligibleItem>();
        for (Pregled p : pregledi) {
            if (jeZavrsen(p)) {
                Ljubimac lj = p.getLjubimac();
                String vlasnik = (lj != null && lj.getVlasnik() != null)
                        ? (safe(lj.getVlasnik().getIme()) + " " + safe(lj.getVlasnik().getPrezime())).trim()
                        : "";
                String termin = p.getTermin() != null ? fmt.format(p.getTermin()) : "";
                out.add(new EligibleItem(p.getId(), lj != null ? lj.getIme() : "", vlasnik, termin));
            }
        }
        // čisto za lepši prikaz – opadajuće po terminu (kao string)
        Collections.sort(out, new Comparator<EligibleItem>() {
            @Override public int compare(EligibleItem a, EligibleItem b) {
                String sa = a.getTerminOpis() == null ? "" : a.getTerminOpis();
                String sb = b.getTerminOpis() == null ? "" : b.getTerminOpis();
                return -sa.compareTo(sb);
            }
        });
        return ResponseEntity.ok(out);
    }

    // ---------- KREIRANJE ZAPISA ----------
    @PostMapping
    public ResponseEntity<?> dodaj(@RequestBody CreateRequest body, Authentication auth) {
        Korisnik vet = ulogovanVeterinar(auth);
        if (vet == null) return ResponseEntity.status(401).body(singleMsg("Niste prijavljeni."));
        if (vet.getUloga() != Uloga.VETERINAR)
            return ResponseEntity.status(403).body(singleMsg("Samo veterinar može unositi medicinske zapise."));
        if (body == null || empty(body.getDijagnoza()))
            return ResponseEntity.badRequest().body(singleMsg("Dijagnoza je obavezna."));

        // Učitaj sve preglede ovog veterinara po MEJLU (ne koristimo findById iz repoa)
        List<Pregled> preglediVeta = pregledRepo.findByVeterinarEmail(vet.getEmail());
        // sort – najskoriji prvi
        Collections.sort(preglediVeta, new Comparator<Pregled>() {
            @Override public int compare(Pregled a, Pregled b) {
                if (a.getTermin() == null && b.getTermin() == null) return 0;
                if (a.getTermin() == null) return 1;
                if (b.getTermin() == null) return -1;
                return b.getTermin().compareTo(a.getTermin());
            }
        });

        Pregled odabrani = null;

        // 1) Ako front šalje pregledId – pronađi ga u okviru pregleda ovog veta
        if (body.getPregledId() != null) {
            for (Pregled p : preglediVeta) {
                if (Objects.equals(p.getId(), body.getPregledId())) {
                    odabrani = p; break;
                }
            }
            if (odabrani == null) return ResponseEntity.status(404).body(singleMsg("Pregled ne postoji kod prijavljenog veterinara."));
            if (!jeZavrsen(odabrani)) return ResponseEntity.status(400).body(singleMsg("Izveštaj se može uneti samo za OBAVLJEN pregled."));
        }
        // 2) Ako front ne šalje ID, koristi ime ljubimca – nađi NAJSKORIJi OBAVLJEN pregled tog ljubimca kod ovog veta
        else if (!empty(body.getLjubimacIme())) {
            for (Pregled p : preglediVeta) {
                Ljubimac lj = p.getLjubimac();
                if (jeZavrsen(p) && lj != null && body.getLjubimacIme().equalsIgnoreCase(lj.getIme())) {
                    odabrani = p; break;
                }
            }
            if (odabrani == null) return ResponseEntity.status(404).body(singleMsg("Nije pronađen OBAVLJEN pregled za tog ljubimca kod prijavljenog veterinara."));
        } else {
            return ResponseEntity.badRequest().body(singleMsg("Odaberite pregled ili ljubimca iz liste."));
        }

        // Kreiraj i sačuvaj zapis
        Ljubimac ljubimac = odabrani.getLjubimac();
        MedicinskiZapis zapis = new MedicinskiZapis();
        zapis.setLjubimac(ljubimac);
        zapis.setVeterinar(vet);
        zapis.setDijagnoza(body.getDijagnoza().trim());
        zapis.setTerapija(empty(body.getTerapija()) ? null : body.getTerapija().trim());

        MedicinskiZapis sacuvan = zapisRepo.save(zapis);
        return ResponseEntity.status(201).body(toDTO(sacuvan));
    }

    // ---------- pomoćne ----------
    private Korisnik ulogovanVeterinar(Authentication auth) {
        if (auth == null || auth.getName() == null) return null;
        return korisnikRepo.findByEmail(auth.getName()).orElse(null);
    }
    private static boolean empty(String s){ return s == null || s.trim().isEmpty(); }

    // Prihvatamo OBAVLJEN/ZAVRSEN/ZAVRŠEN – prilagodi ako je tvoj enum drugačiji
    private static boolean jeZavrsen(Pregled p){
        if (p == null || p.getStatus() == null) return false;
        String s = p.getStatus().toString().toUpperCase(Locale.ROOT);
        return s.equals("OBAVLJEN") || s.equals("ZAVRSEN") || s.equals("ZAVRŠEN");
    }

    private static Map<String,String> singleMsg(String msg) {
        Map<String,String> m = new HashMap<String,String>();
        m.put("message", msg);
        return m;
    }
}
