<%@ page contentType="text/html; charset=UTF-8" isELIgnored="true" %>
<!DOCTYPE html>
<html lang="sr">
<head>
  <meta charset="UTF-8">
  <title>Pregledi</title>
  <style>
    body{font-family:system-ui,Arial;margin:0;background:#f7f9fb}
    header{display:flex;align-items:center;justify-content:space-between;gap:16px;
           padding:16px 24px;background:#fff;border-bottom:1px solid #e6e6e6}
    nav a{margin-right:12px;text-decoration:none;color:#0b5ed7}
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
    table{width:100%;border-collapse:collapse;background:#fff;border:1px solid #e6e6e6}
    th,td{padding:10px;border-top:1px solid #eee;text-align:left;vertical-align:top}
    thead tr{background:#f2f4f7}
    .muted{color:#6b7280}
    button{background:#0b5ed7;color:#fff;border:none;border-radius:8px;padding:8px 12px;cursor:pointer}
    button:disabled{opacity:.6;cursor:not-allowed}
    input,select,textarea{padding:6px 8px;border:1px solid #dcdcdc;border-radius:8px}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .card{background:#fff;border:1px solid #e6e6e6;border-radius:12px;padding:14px;margin:14px 0}
    .danger{background:#dc2626}
    .no-access{display:none;background:#fff;border:1px solid #e6e6e6;border-radius:12px;padding:32px;text-align:center}
    .no-access img{max-width:220px;height:auto;display:block;margin:0 auto 16px}
    .no-access h2{margin:8px 0 6px}
    .no-access p{color:#666;margin:0 0 12px}
  </style>
</head>
<body>
<header>
  <div style="display:flex;align-items:center;gap:12px">
    <img src="/img/logo.png" alt="Logo" style="height:46px">
    <strong>Veterinarska stanica</strong>
  </div>
  <nav>
    <a href="/">Poƒçetna</a>
    <a href="/ljubimci">Ljubimci</a>
    <a href="/pregledi">Pregledi</a>
    <a href="/poruke">Poruke</a>
    <a id="navIzvestaji" href="/izvestaji" style="display:none">Izve≈°taji</a>
  </nav>
  <div id="userBox"><span id="userInfo"></span>
    <button id="btnLogout" style="display:none;margin-left:8px">Odjava</button>
  </div>
</header>

<div class="wrap">
  <h1>üìÖ Pregledi</h1>
  <div id="msg" class="muted" style="margin:8px 0 16px 0"></div>

  <!-- NO-ACCESS: vidljivo kada korisnik NIJE prijavljen -->
  <div id="noAccessPregledi" class="no-access">
    <img src="/img/tuzna.png" alt="Nema pristup">
    <h2>Morate biti prijavljeni</h2>
    <p>Prijavite se da biste videli svoje preglede.</p>
    <a class="btn" href="/prijava">Prijava</a>
  </div>

  <!-- PRIV ZONA: vidi se samo kad postoji JWT i imamo pristup -->
  <div id="privPregledi" style="display:none">

    <!-- ADMIN filteri: vidljivo samo adminu -->
    <div id="adminPanel" class="card" style="display:none">
      <div class="row">
        <label>Datum: <input id="inpDate" type="date"></label>
        <label>Veterinar ID: <input id="inpVetId" type="number" style="width:120px"></label>
        <button id="btnPoDanu">Prika≈æi za dan</button>
        <button id="btnPoVet">Prika≈æi za veterinara</button>
        <button id="btnSve">Sve (po ulozi)</button>
      </div>
    </div>

    <!-- VLASNIK -->
    <div id="ownerPanel" class="card" style="display:none">
      <h3 style="margin:0 0 8px 0">‚ûï Novi pregled (VLASNIK)</h3>
      <div class="row">
        <label>Ljubimac
          <select id="selLjubimac" style="min-width:220px">
            <option value="">‚Äî izaberi ljubimca ‚Äî</option>
          </select>
        </label>

        <label>Veterinar
          <select id="selVeterinar" style="min-width:220px">
            <option value="">‚Äî izaberi veterinara ‚Äî</option>
          </select>
        </label>

        <label>Usluga
          <input id="npUslugaTxt" placeholder="npr. Vakcinacija, Kontrolni pregled" style="min-width:240px">
        </label>

        <label>Poƒçetak
          <input id="npStart" type="datetime-local">
        </label>

        <input id="npNapomena" placeholder="Napomena" style="min-width:240px">
        <button id="btnAdd">Saƒçuvaj</button>
        <span id="addMsg" class="muted"></span>
      </div>

      <h4 style="margin:16px 0 8px 0">‚úèÔ∏è Izmeni termin (VLASNIK)</h4>
      <div class="row">
        <label>Pregled ID <input id="edId" type="number" style="width:100px"></label>
        <label>Usluga ID <input id="edUslugaId" type="number" style="width:100px"></label>

        <label>Poƒçetak
          <input id="edStart" type="datetime-local">
        </label>

        <!-- KRAJ UKLONJEN -->
        <input id="edNapomena" placeholder="Napomena" style="min-width:200px">
        <button id="btnEdit">Izmeni</button>
        <span id="editMsg" class="muted"></span>
      </div>

      <h4 style="margin:16px 0 8px 0">üóë Otkazivanje (VLASNIK)</h4>
      <div class="row">
        <label>Pregled ID <input id="delId" type="number" style="width:100px"></label>
        <button id="btnDel" class="danger">Otka≈æi</button>
        <span id="delMsg" class="muted"></span>
      </div>
    </div>

    <!-- VETERINAR -->
    <div id="vetPanel" class="card" style="display:none">
      <h3 style="margin:0 0 8px 0">‚úÖ Promeni status (VETERINAR)</h3>
      <div class="row">
        <label>Pregled ID <input id="stId" type="number" style="width:100px"></label>
        <select id="stVal">
          <option>ZAKAZAN</option>
          <option>POTVRƒêEN</option>
          <option>OBAVLJEN</option>
          <option>OTKAZAN</option>
        </select>
        <button id="btnStatus">Primeni</button>
        <span id="stMsg" class="muted"></span>
      </div>

      <h3 style="margin:16px 0 8px 0">ü©∫ Medicinski zapis (VETERINAR)</h3>
      <div class="row">
        <label>Ljubimac ID <input id="mzLjubimacId" type="number" style="width:120px"></label>
        <label>Dijagnoza <input id="mzDijagnoza" placeholder="Obavezno" style="min-width:200px"></label>
        <label>Terapija <input id="mzTerapija" placeholder="Opcionalno" style="min-width:200px"></label>
        <button id="btnZapisi">Saƒçuvaj zapis</button>
        <span id="mzMsg" class="muted"></span>
      </div>
    </div>

    <table id="tbl">
      <thead>
        <tr>
          <th>ID</th>
          <th>Ljubimac</th>
          <th>Veterinar</th>
          <th>Usluga</th>
          <th>Poƒçetak</th>
          <th>Kraj</th>
          <th>Status</th>
          <th>Napomena</th>
        </tr>
      </thead>
      <tbody id="rows">
        <tr><td colspan="8">Uƒçitavam‚Ä¶</td></tr>
      </tbody>
    </table>

    <div id="vetZapisiCard" class="card" style="display:none">
      <h3 style="margin:0 0 8px 0">ü©∫ Medicinski zapisi</h3>
      <div id="mzInfo" class="muted" style="margin-bottom:8px">Uƒçitavam‚Ä¶</div>
      <table style="width:100%;border-collapse:collapse;background:#fff;border:1px solid #e6e6e6">
        <thead>
          <tr style="background:#f2f4f7">
            <th>Datum</th>
            <th>Ljubimac</th>
            <th>Dijagnoza</th>
            <th>Terapija</th>
            <th>Veterinar</th>
          </tr>
        </thead>
        <tbody id="mzRows">
          <tr><td colspan="5">Uƒçitavam‚Ä¶</td></tr>
        </tbody>
      </table>
    </div>

  </div>
</div>

<script src="/js/auth.js"></script>
<script>
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', paintUserInfoHeader);
  } else {
    paintUserInfoHeader();
  }
</script>

<script>
// ------------------ Uloge / paneli ------------------
(function toggleRolePanels(){
  try{
    const roles = (JSON.parse(localStorage.getItem('roles')||'[]')||[]).map(r=>r.authority||'');
    const isAdmin = roles.includes('ROLE_ADMIN');
    document.getElementById('ownerPanel').style.display = roles.includes('ROLE_VLASNIK') ? 'block' : 'none';
    document.getElementById('vetPanel').style.display   = roles.includes('ROLE_VETERINAR') ? 'block' : 'none';
    document.getElementById('adminPanel').style.display = isAdmin ? 'block' : 'none';
  }catch(e){}
})();

function fmt(iso){ if(!iso) return ''; const d=new Date(iso); return isNaN(d)?iso:d.toLocaleString(); }
function safe(v){ return (v===null||v===undefined)?'':String(v); }
function fmtDateOnly(iso){
  if(!iso) return '';
  if (/^\d{4}-\d{2}-\d{2}$/.test(iso)) return iso;
  const d = new Date(iso);
  return isNaN(d) ? iso : d.toLocaleDateString();
}

// ------------------ Tabela pregleda ------------------
async function fetchAndRender(url){
  const msg  = document.getElementById('msg');
  const rows = document.getElementById('rows');
  const priv = document.getElementById('privPregledi');

  if(!localStorage.getItem('jwt')){
    msg.innerHTML='Niste prijavljeni. <a href="/prijava">Prijavite se</a> da vidite preglede.';
    if (priv) priv.style.display='none';
    return;
  }

  rows.innerHTML='<tr><td colspan="8">Uƒçitavam‚Ä¶</td></tr>';
  try{
    const data = await fetchJSON(url,{headers:authHeader()}, 'msg', null, { appendServerText:false });
    if (priv) priv.style.display='';

    if(!Array.isArray(data)||data.length===0){
      rows.innerHTML='<tr><td colspan="8">Nema termina.</td></tr>';
      showMsg('msg','');
      return;
    }
    rows.innerHTML = data.map(function(p){
      return '<tr>'
        + '<td>'+(p.id||'')+'</td>'
        + '<td>'+(p.ljubimacIme||'')+'</td>'
        + '<td>'+(p.veterinarIme||'')+'</td>'
        + '<td>'+(p.uslugaNaziv||'')+'</td>'
        + '<td>'+fmt(p.datumPocetka)+'</td>'
        + '<td>'+fmt(p.datumZavrsetka)+'</td>'
        + '<td>'+(p.status||'')+'</td>'
        + '<td>'+(p.napomena||'')+'</td>'
        + '</tr>';
    }).join('');
    showMsg('msg','');
  }catch(_){
    if (priv) priv.style.display='none';
    rows.innerHTML='';
  }
}
async function loadAll(){ await fetchAndRender('/api/pregledi'); }

// ------------------ Dropdown punjenje ------------------
async function loadMyPets(){
  const sel = document.getElementById('selLjubimac');
  if(!sel) return;
  sel.innerHTML = '<option value="">Uƒçitavam‚Ä¶</option>';
  try{
    const data = await fetchJSON('/api/ljubimci', { headers: authHeader() }, 'msg', null, { appendServerText:false });
    const list = (Array.isArray(data)?data:[])
      .map(p => ({ id:p.id, label: (p.ime || 'Bez imena') + (p.rasa ? (' ‚Äì ' + p.rasa) : '') }))
      .sort((a,b)=> a.label.localeCompare(b.label, 'sr'));
    sel.innerHTML = '<option value="">‚Äî izaberi ljubimca ‚Äî</option>' +
      list.map(p => `<option value="${p.id}">${p.label}</option>`).join('');
  }catch(_){
    sel.innerHTML = '<option value="">Gre≈°ka pri uƒçitavanju</option>';
  }
}

async function loadVets(){
  const sel = document.getElementById('selVeterinar');
  if(!sel) return;
  sel.innerHTML = '<option value="">Uƒçitavam‚Ä¶</option>';
  try{
    const data = await fetchJSON('/api/korisnici/veterinari', { headers: authHeader() }, 'msg', null, { appendServerText:false });
    const list = (Array.isArray(data)?data:[])
      .map(v => {
        const ime = v.ime || '';
        const prezime = v.prezime || '';
        const label = (ime || prezime) ? (ime + ' ' + prezime).trim() : (v.email || ('#'+v.id));
        return { id:v.id, label };
      })
      .sort((a,b)=> a.label.localeCompare(b.label, 'sr'));
    sel.innerHTML = '<option value="">‚Äî izaberi veterinara ‚Äî</option>' +
      list.map(v => `<option value="${v.id}">${v.label}</option>`).join('');
  }catch(_){
    sel.innerHTML = '<option value="">Gre≈°ka pri uƒçitavanju</option>';
  }
}

// ------------------ Medicinski zapisi (vet) ------------------
async function loadZapisi(){
  const card = document.getElementById('vetZapisiCard');
  const info = document.getElementById('mzInfo');
  const rows = document.getElementById('mzRows');

  if (!card) return;
  if (document.getElementById('vetPanel').style.display === 'none'){
    card.style.display='none';
    return;
  }
  card.style.display='block';
  info.textContent = 'Uƒçitavam‚Ä¶';
  rows.innerHTML = '<tr><td colspan="5">Uƒçitavam‚Ä¶</td></tr>';

  try{
    const data = await fetchJSON('/api/medicinski-zapisi', { headers: authHeader() }, 'mzInfo', null, { appendServerText:false });

    if (!Array.isArray(data) || data.length === 0){
      rows.innerHTML = '<tr><td colspan="5">Nema zapisa.</td></tr>';
      info.textContent = '';
      return;
    }

    rows.innerHTML = data.map(z => {
      const datum      = safe(z.datum || z.datumKreiranja || z.createdAt);
      const ljubimac   = safe(z.ljubimacIme || z.ljubimac || (z.ljubimac && z.ljubimac.ime));
      const dijagnoza  = safe(z.dijagnoza);
      const terapija   = safe(z.terapija);
      const veterinar  = safe(z.veterinarIme || z.veterinar || (z.veterinar && z.veterinar.ime));
      return '<tr>'
        + '<td>'+fmtDateOnly(datum)+'</td>'
        + '<td>'+ljubimac+'</td>'
        + '<td>'+dijagnoza+'</td>'
        + '<td>'+terapija+'</td>'
        + '<td>'+veterinar+'</td>'
        + '</tr>';
    }).join('');
    info.textContent='';
  }catch(e){
    rows.innerHTML = '<tr><td colspan="5">Gre≈°ka pri uƒçitavanju zapisa.</td></tr>';
    info.textContent = e.message || 'Gre≈°ka.';
  }
}

// ------------------ INIT ------------------
window.addEventListener('load', ()=>{
  const token = localStorage.getItem('jwt');
  const noacc = document.getElementById('noAccessPregledi');
  const priv  = document.getElementById('privPregledi');

  if (!token){
    if (noacc) noacc.style.display = 'block';
    if (priv)  priv.style.display  = 'none';
    return;
  }

  if (noacc) noacc.style.display = 'none';
  if (priv)  priv.style.display  = 'block';

  loadAll();
  loadZapisi();
  loadMyPets();
  loadVets();

  const btnSve = document.getElementById('btnSve');
  const btnPoDanu = document.getElementById('btnPoDanu');
  const btnPoVet = document.getElementById('btnPoVet');

  if (document.getElementById('adminPanel').style.display !== 'none') {
    btnSve && (btnSve.onclick = ()=> fetchAndRender('/api/pregledi'));
    btnPoDanu && (btnPoDanu.onclick = ()=>{
      const d=(document.getElementById('inpDate').value||'').trim();
      if(!d){ showMsg('msg','Izaberi datum.'); return; }
      fetchAndRender('/api/pregledi/po-danu?date='+encodeURIComponent(d));
    });
    btnPoVet && (btnPoVet.onclick = ()=>{
      const id=(document.getElementById('inpVetId').value||'').trim();
      if(!id){ showMsg('msg','Unesi veterinarId.'); return; }
      const d=(document.getElementById('inpDate').value||'').trim();
      const q=d?('&date='+encodeURIComponent(d)):'';
      fetchAndRender('/api/pregledi/po-veterinaru?veterinarId='+encodeURIComponent(id)+q);
    });
  }
});

// ------------------ Akcije vlasnika ------------------
document.getElementById('btnAdd')?.addEventListener('click', async ()=>{
  const out=document.getElementById('addMsg');

  try{
    const uslTxt = (document.getElementById('npUslugaTxt').value||'').trim();
    const ljubId = Number(document.getElementById('selLjubimac').value);
    const vetId  = Number(document.getElementById('selVeterinar').value);
    const start  = (document.getElementById('npStart').value||'').trim();

    if(!ljubId){ out.textContent='Izaberite ljubimca.'; return; }
    if(!vetId){ out.textContent='Izaberite veterinara.'; return; }
    if(!uslTxt){ out.textContent='Unesite naziv usluge.'; return; }
    if(!start){ out.textContent='Izaberite datum i vreme.'; return; }

    const res = await fetchJSON('/api/usluge/resolve?naziv='+encodeURIComponent(uslTxt),
                                { headers: authHeader() }, 'addMsg');
    const uslugaId = res.id;

    const body={
      ljubimac:{id:ljubId},
      veterinar:{id:vetId},
      usluga:{id:Number(uslugaId)},
      datumPocetka:start,
      datumZavrsetka:null,
      napomena:(document.getElementById('npNapomena').value||null)
    };

    await fetchJSON('/api/pregledi',{
      method:'POST',
      headers:{...authHeader(),'Content-Type':'application/json'},
      body:JSON.stringify(body)
    }, 'addMsg', null, { appendServerText:false });

    out.textContent='Saƒçuvano ‚úÖ'; await loadAll();
  }catch(e){
    out.textContent = e.message || 'Gre≈°ka pri ƒçuvanju.';
  }
});

document.getElementById('btnEdit')?.addEventListener('click', async ()=>{
  const out=document.getElementById('editMsg');
  const id=Number(document.getElementById('edId').value); if(!id){ out.textContent='Unesi ID.'; return; }
  const body={
    usluga:(document.getElementById('edUslugaId').value?{id:Number(document.getElementById('edUslugaId').value)}:null),
    datumPocetka:(document.getElementById('edStart').value||null),
    datumZavrsetka:null, // kraj vi≈°e ne koristimo
    napomena:(document.getElementById('edNapomena').value||null)
  };
  try{
    await fetchJSON('/api/pregledi/'+id,{
      method:'PUT',
      headers:{...authHeader(),'Content-Type':'application/json'},
      body:JSON.stringify(body)
    }, 'editMsg', null, { appendServerText:false });
    out.textContent='Izmenjeno ‚úÖ'; await loadAll();
  }catch(_){}
});

document.getElementById('btnDel')?.addEventListener('click', async ()=>{
  const out=document.getElementById('delMsg');
  const id=Number(document.getElementById('delId').value); if(!id){ out.textContent='Unesi ID.'; return; }
  if(!confirm('Otkazati pregled #'+id+'?')) return;
  try{
    const res = await fetch('/api/pregledi/'+id,{method:'DELETE',headers:authHeader()});
    if (res.status !== 204) {
      const txt = await res.text();
      const msg = friendlyHttpMessage(res) + (txt ? (' ‚Äì ' + txt) : '');
      throw new Error(msg);
    }
    out.textContent='Otkazano ‚úÖ'; await loadAll();
  }catch(e){ out.textContent = e.message; }
});

// ------------------ Veterinar: status & zapisi ------------------
document.getElementById('btnStatus')?.addEventListener('click', async ()=>{
  const out=document.getElementById('stMsg');
  const id=Number(document.getElementById('stId').value);
  const status=document.getElementById('stVal').value;
  if(!id){ out.textContent='Unesi ID.'; return; }
  try{
    await fetchJSON('/api/pregledi/'+id+'/status',{
      method:'PATCH',
      headers:{...authHeader(),'Content-Type':'application/json'},
      body:JSON.stringify({status})
    }, 'stMsg', null, { appendServerText:false });
    out.textContent='Status izmenjen ‚úÖ'; await loadAll();
  }catch(_){}
});

document.getElementById('btnZapisi')?.addEventListener('click', async ()=>{
  const out = document.getElementById('mzMsg');
  const ljubimacId = Number(document.getElementById('mzLjubimacId').value);
  const dijagnoza = (document.getElementById('mzDijagnoza').value||'').trim();
  const terapija = (document.getElementById('mzTerapija').value||'').trim();

  if(!ljubimacId || !dijagnoza){
    out.textContent = 'Unesi Ljubimac ID i dijagnozu.'; return;
  }

  try{
    await fetchJSON('/api/medicinski-zapisi',{
      method:'POST',
      headers:{...authHeader(),'Content-Type':'application/json'},
      body:JSON.stringify({ ljubimacId, dijagnoza, terapija })
    }, 'mzMsg', null, { appendServerText:false });

    out.textContent = 'Zapis saƒçuvan ‚úÖ';
    await loadZapisi();
  }catch(e){
    out.textContent = e.message || 'Gre≈°ka pri ƒçuvanju.';
  }
});
</script>
</body>
</html>
