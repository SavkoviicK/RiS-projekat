<%@ page contentType="text/html; charset=UTF-8" isELIgnored="true" %>
<!DOCTYPE html>
<html lang="sr">
<head>
  <meta charset="UTF-8">
  <title>Pregledi</title>
  <style>
    body{font-family:system-ui,Arial;margin:0;background:#f7f9fb}
    header{display:flex;align-items:center;justify-content:space-between;gap:16px;
           padding:16px 24px;background:#fff;border-bottom:1px solid #e6e6e6}
    nav a{margin-right:12px;text-decoration:none;color:#0b5ed7}
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
    table{width:100%;border-collapse:collapse;background:#fff;border:1px solid #e6e6e6}
    th,td{padding:10px;border-top:1px solid #eee;text-align:left;vertical-align:top}
    thead tr{background:#f2f4f7}
    .muted{color:#6b7280}
    button{background:#0b5ed7;color:#fff;border:none;border-radius:8px;padding:8px 12px;cursor:pointer}
    button:disabled{opacity:.6;cursor:not-allowed}
    input,select,textarea{padding:6px 8px;border:1px solid #dcdcdc;border-radius:8px}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .card{background:#fff;border:1px solid #e6e6e6;border-radius:12px;padding:14px;margin:14px 0}
    .danger{background:#dc2626}
  </style>
</head>
<body>
<header>
  <div style="display:flex;align-items:center;gap:12px">
    <img src="/img/logo.png" alt="Logo" style="height:46px">
    <strong>Veterinarska stanica</strong>
  </div>
  <nav>
    <a href="/">Poƒçetna</a>
    <a href="/ljubimci">Ljubimci</a>
    <a href="/pregledi">Pregledi</a>
    <a href="/poruke">Poruke</a>
    <a id="navIzvestaji" href="/izvestaji" style="display:none">Izve≈°taji</a>
  </nav>
  <div id="userBox"><span id="userInfo"></span>
    <button id="btnLogout" style="display:none;margin-left:8px">Odjava</button>
  </div>
</header>

<div class="wrap">
  <h1>üìÖ Pregledi</h1>
  <div id="msg" class="muted" style="margin:8px 0 16px 0"></div>

  <!-- PRIV ZONA: vidi se samo kad postoji JWT i imamo pristup -->
  <div id="privPregledi" style="display:none">
    <div class="card">
      <div class="row">
        <label>Datum: <input id="inpDate" type="date"></label>
        <label>Veterinar ID: <input id="inpVetId" type="number" style="width:120px"></label>
        <button id="btnPoDanu">Prika≈æi za dan</button>
        <button id="btnPoVet">Prika≈æi za veterinara</button>
        <button id="btnSve">Sve (po ulozi)</button>
      </div>
    </div>

    <div id="ownerPanel" class="card" style="display:none">
      <h3 style="margin:0 0 8px 0">‚ûï Novi pregled (VLASNIK)</h3>
      <div class="row">
        <label>Ljubimac ID <input id="npLjubimacId" type="number" style="width:120px"></label>
        <label>Veterinar ID <input id="npVetId" type="number" style="width:120px"></label>
        <!-- Usluga kao TEKST (umesto ID) -->
        <label>Usluga  <input id="npUslugaTxt" placeholder="npr. Vakcinacija, Kontrolni pregled" style="min-width:240px"></label>
        <label>Poƒçetak (ISO) <input id="npStart" placeholder="2025-09-01T10:00"></label>
        <label>Kraj (ISO) <input id="npEnd" placeholder="2025-09-01T10:30"></label>
        <input id="npNapomena" placeholder="Napomena" style="min-width:240px">
        <button id="btnAdd">Saƒçuvaj</button>
        <span id="addMsg" class="muted"></span>
      </div>

      <h4 style="margin:16px 0 8px 0">‚úèÔ∏è Izmeni termin (VLASNIK)</h4>
      <div class="row">
        <label>Pregled ID <input id="edId" type="number" style="width:100px"></label>
        <label>Usluga ID <input id="edUslugaId" type="number" style="width:100px"></label>
        <label>Poƒçetak (ISO) <input id="edStart" placeholder="2025-09-01T11:00"></label>
        <label>Kraj (ISO) <input id="edEnd" placeholder="2025-09-01T11:30"></label>
        <input id="edNapomena" placeholder="Napomena" style="min-width:200px">
        <button id="btnEdit">Izmeni</button>
        <span id="editMsg" class="muted"></span>
      </div>

      <h4 style="margin:16px 0 8px 0">üóë Otkazivanje (VLASNIK)</h4>
      <div class="row">
        <label>Pregled ID <input id="delId" type="number" style="width:100px"></label>
        <button id="btnDel" class="danger">Otka≈æi</button>
        <span id="delMsg" class="muted"></span>
      </div>
    </div>

    <div id="vetPanel" class="card" style="display:none">
      <h3 style="margin:0 0 8px 0">‚úÖ Promeni status (VETERINAR)</h3>
      <div class="row">
        <label>Pregled ID <input id="stId" type="number" style="width:100px"></label>
        <select id="stVal">
          <option>ZAKAZAN</option>
          <option>POTVRƒêEN</option>
          <option>OBAVLJEN</option>
          <option>OTKAZAN</option>
        </select>
        <button id="btnStatus">Primeni</button>
        <span id="stMsg" class="muted"></span>
      </div>
    </div>

    <table id="tbl">
      <thead>
        <tr>
          <th>ID</th>
          <th>Ljubimac</th>
          <th>Veterinar</th>
          <th>Usluga</th>
          <th>Poƒçetak</th>
          <th>Kraj</th>
          <th>Status</th>
          <th>Napomena</th>
        </tr>
      </thead>
      <tbody id="rows">
        <tr><td colspan="8">Uƒçitavam‚Ä¶</td></tr>
      </tbody>
    </table>
  </div>
</div>

<script src="/js/auth.js"></script>
<script>
  // Jedinstven header iz auth.js
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', paintUserInfoHeader);
  } else {
    paintUserInfoHeader();
  }
</script>

<script>
// Poka≈æi/sakrij panele po ulozi; koristi raw authority vrednosti iz localStorage
(function toggleRolePanels(){
  try{
    const roles = (JSON.parse(localStorage.getItem('roles')||'[]')||[]).map(r=>r.authority||'');
    document.getElementById('ownerPanel').style.display = roles.includes('ROLE_VLASNIK') ? 'block' : 'none';
    document.getElementById('vetPanel').style.display   = roles.includes('ROLE_VETERINAR') ? 'block' : 'none';
  }catch(e){}
})();

function fmt(iso){ if(!iso) return ''; const d=new Date(iso); return isNaN(d)?iso:d.toLocaleString(); }

async function fetchAndRender(url){
  const msg  = document.getElementById('msg');
  const rows = document.getElementById('rows');
  const priv = document.getElementById('privPregledi');

  if(!localStorage.getItem('jwt')){
    msg.innerHTML='Niste prijavljeni. <a href="/prijava">Prijavite se</a> da vidite preglede.';
    if (priv) priv.style.display='none';
    return;
  }

  rows.innerHTML='<tr><td colspan="8">Uƒçitavam‚Ä¶</td></tr>';
  try{
    const data = await fetchJSON(url,{headers:authHeader()}, 'msg', null, { appendServerText:false });
    if (priv) priv.style.display='';

    if(!Array.isArray(data)||data.length===0){
      rows.innerHTML='<tr><td colspan="8">Nema termina.</td></tr>';
      showMsg('msg','');
      return;
    }
    rows.innerHTML = data.map(function(p){
      return '<tr>'
        + '<td>'+(p.id||'')+'</td>'
        + '<td>'+(p.ljubimacIme||'')+'</td>'
        + '<td>'+(p.veterinarIme||'')+'</td>'
        + '<td>'+(p.uslugaNaziv||'')+'</td>'
        + '<td>'+fmt(p.datumPocetka)+'</td>'
        + '<td>'+fmt(p.datumZavrsetka)+'</td>'
        + '<td>'+(p.status||'')+'</td>'
        + '<td>'+(p.napomena||'')+'</td>'
        + '</tr>';
    }).join('');
    showMsg('msg','');
  }catch(_){
    if (priv) priv.style.display='none';
    rows.innerHTML='';
  }
}
async function loadAll(){ await fetchAndRender('/api/pregledi'); }

window.addEventListener('load', ()=>{
  loadAll();
  document.getElementById('btnSve').onclick = ()=> fetchAndRender('/api/pregledi');
  document.getElementById('btnPoDanu').onclick = ()=>{
    const d=(document.getElementById('inpDate').value||'').trim();
    if(!d){ showMsg('msg','Izaberi datum.'); return; }
    fetchAndRender('/api/pregledi/po-danu?date='+encodeURIComponent(d));
  };
  document.getElementById('btnPoVet').onclick = ()=>{
    const id=(document.getElementById('inpVetId').value||'').trim();
    if(!id){ showMsg('msg','Unesi veterinarId.'); return; }
    const d=(document.getElementById('inpDate').value||'').trim();
    const q=d?('&date='+encodeURIComponent(d)):'';
    fetchAndRender('/api/pregledi/po-veterinaru?veterinarId='+encodeURIComponent(id)+q);
  };
});

// VLASNIK: add/edit/delete

// === KREIRANJE: Usluga kao TEKST (resolve -> pa POST) ===
document.getElementById('btnAdd')?.addEventListener('click', async ()=>{
  const out=document.getElementById('addMsg');

  try{
    const uslTxt = (document.getElementById('npUslugaTxt').value||'').trim();
    if(!uslTxt){ out.textContent='Unesite naziv usluge.'; return; }

    // 1) Resolve usluge po nazivu (naƒëe ili kreira) -> vrati {id}
    const res = await fetchJSON('/api/usluge/resolve?naziv='+encodeURIComponent(uslTxt),
                                { headers: authHeader() }, 'addMsg');
    const uslugaId = res.id;

    // 2) Sa dobijenim ID-jem po≈°alji regularan POST /api/pregledi
    const body={
      ljubimac:{id:Number(document.getElementById('npLjubimacId').value)},
      veterinar:{id:Number(document.getElementById('npVetId').value)},
      usluga:{id:Number(uslugaId)},
      datumPocetka:(document.getElementById('npStart').value||null),
      datumZavrsetka:(document.getElementById('npEnd').value||null),
      napomena:(document.getElementById('npNapomena').value||null)
    };

    await fetchJSON('/api/pregledi',{
      method:'POST',
      headers:{...authHeader(),'Content-Type':'application/json'},
      body:JSON.stringify(body)
    }, 'addMsg', null, { appendServerText:false });

    out.textContent='Saƒçuvano ‚úÖ'; await loadAll();
  }catch(e){
    out.textContent = e.message || 'Gre≈°ka pri ƒçuvanju.';
  }
});

document.getElementById('btnEdit')?.addEventListener('click', async ()=>{
  const out=document.getElementById('editMsg');
  const id=Number(document.getElementById('edId').value); if(!id){ out.textContent='Unesi ID.'; return; }
  const body={
    usluga:(document.getElementById('edUslugaId').value?{id:Number(document.getElementById('edUslugaId').value)}:null),
    datumPocetka:(document.getElementById('edStart').value||null),
    datumZavrsetka:(document.getElementById('edEnd').value||null),
    napomena:(document.getElementById('edNapomena').value||null)
  };
  try{
    await fetchJSON('/api/pregledi/'+id,{
      method:'PUT',
      headers:{...authHeader(),'Content-Type':'application/json'},
      body:JSON.stringify(body)
    }, 'editMsg', null, { appendServerText:false });
    out.textContent='Izmenjeno ‚úÖ'; await loadAll();
  }catch(_){}
});

document.getElementById('btnDel')?.addEventListener('click', async ()=>{
  const out=document.getElementById('delMsg');
  const id=Number(document.getElementById('delId').value); if(!id){ out.textContent='Unesi ID.'; return; }
  if(!confirm('Otkazati pregled #'+id+'?')) return;
  try{
    const res = await fetch('/api/pregledi/'+id,{method:'DELETE',headers:authHeader()});
    if (res.status !== 204) {
      const txt = await res.text();
      const msg = friendlyHttpMessage(res) + (txt ? (' ‚Äì ' + txt) : '');
      throw new Error(msg);
    }
    out.textContent='Otkazano ‚úÖ'; await loadAll();
  }catch(e){ out.textContent = e.message; }
});

// VETERINAR: status
document.getElementById('btnStatus')?.addEventListener('click', async ()=>{
  const out=document.getElementById('stMsg');
  const id=Number(document.getElementById('stId').value);
  const status=document.getElementById('stVal').value;
  if(!id){ out.textContent='Unesi ID.'; return; }
  try{
    await fetchJSON('/api/pregledi/'+id+'/status',{
      method:'PATCH',
      headers:{...authHeader(),'Content-Type':'application/json'},
      body:JSON.stringify({status})
    }, 'stMsg', null, { appendServerText:false });
    out.textContent='Status izmenjen ‚úÖ'; await loadAll();
  }catch(_){}
});
</script>
</body>
</html>
