package com.veterinarska.stanica.service;

import com.veterinarska.stanica.model.Korisnik;
import com.veterinarska.stanica.model.Poruka;
import com.veterinarska.stanica.repository.KorisnikRepository;
import com.veterinarska.stanica.repository.PorukaRepository;
import com.veterinarska.stanica.repository.PrijateljstvoRepository;
import org.springframework.stereotype.Service;

import java.util.List;

@Service
public class PorukaService {

    private final PorukaRepository porukaRepo;
    private final KorisnikRepository korisnikRepo;
    private final PrijateljstvoRepository prijateljstvoRepo;

    public PorukaService(PorukaRepository porukaRepo,
                         KorisnikRepository korisnikRepo,
                         PrijateljstvoRepository prijateljstvoRepo) {
        this.porukaRepo = porukaRepo;
        this.korisnikRepo = korisnikRepo;
        this.prijateljstvoRepo = prijateljstvoRepo;
    }

    /** Pravilo:
     *  - VLASNIK -> VLASNIK: mora postojati prijateljstvo
     *  - Sve ostale kombinacije (VLASNIK<->VETERINAR/ADMIN, VETERINAR<->ADMIN): dozvoljene bez provere prijateljstva
     */
    public void posalji(Long posiljalacId, Long primalacId, String sadrzaj) {
        if (posiljalacId == null || primalacId == null) {
            throw new IllegalArgumentException("Nedostaje ID pošiljaoca ili primaoca.");
        }
        if (posiljalacId.equals(primalacId)) {
            throw new IllegalArgumentException("Ne možeš slati poruku samom sebi.");
        }
        if (sadrzaj == null || sadrzaj.isBlank()) {
            throw new IllegalArgumentException("Sadržaj poruke je prazan.");
        }

        Korisnik posiljalac = korisnikRepo.findById(posiljalacId)
                .orElseThrow(() -> new IllegalArgumentException("Pošiljalac ne postoji"));
        Korisnik primalac = korisnikRepo.findById(primalacId)
                .orElseThrow(() -> new IllegalArgumentException("Primalac ne postoji"));

        String r1 = posiljalac.getUloga().name(); // prilagodi ako nije enum/name()
        String r2 = primalac.getUloga().name();

        boolean vlasnikVlasnik = "VLASNIK".equalsIgnoreCase(r1) && "VLASNIK".equalsIgnoreCase(r2);
        if (vlasnikVlasnik) {
            boolean prijatelji = prijateljstvoRepo.jesuPrijatelji(posiljalac.getId(), primalac.getId());
            if (!prijatelji) {
                throw new IllegalStateException("Vlasnik može slati poruku vlasniku samo ako su prijatelji.");
            }
        }

        Poruka p = new Poruka();
        p.setPosiljalac(posiljalac);
        p.setPrimalac(primalac);
        p.setSadrzaj(sadrzaj);
        porukaRepo.save(p);
    }

    public List<Poruka> konverzacija(Long aId, Long bId) {
        Korisnik a = korisnikRepo.findById(aId)
                .orElseThrow(() -> new IllegalArgumentException("Korisnik A ne postoji"));
        Korisnik b = korisnikRepo.findById(bId)
                .orElseThrow(() -> new IllegalArgumentException("Korisnik B ne postoji"));
        return porukaRepo.konverzacija(a, b);
    }
}
