<%@ page contentType="text/html; charset=UTF-8" isELIgnored="true" %>
<!DOCTYPE html>
<html lang="sr">
<head>
  <meta charset="UTF-8">
  <title>Pregledi</title>
  <style>
    body{font-family:system-ui,Arial;margin:0;background:#f7f9fb}
    header{display:flex;align-items:center;justify-content:space-between;gap:16px;
           padding:16px 24px;background:#fff;border-bottom:1px solid #e6e6e6}
    nav a{margin-right:12px;text-decoration:none;color:#0b5ed7}
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
    table{width:100%;border-collapse:collapse;background:#fff;border:1px solid #e6e6e6}
    th,td{padding:10px;border-top:1px solid #eee;text-align:left;vertical-align:top}
    thead tr{background:#f2f4f7}
    .muted{color:#6b7280}
    button{background:#0b5ed7;color:#fff;border:none;border-radius:8px;padding:8px 12px;cursor:pointer}
    button:disabled{opacity:.6;cursor:not-allowed}
    input,select,textarea{padding:6px 8px;border:1px solid #dcdcdc;border-radius:8px}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .card{background:#fff;border:1px solid #e6e6e6;border-radius:12px;padding:14px;margin:14px 0}
    .danger{background:#dc2626}
    .no-access{display:none;background:#fff;border:1px solid #e6e6e6;border-radius:12px;padding:32px;text-align:center}
    .no-access img{max-width:220px;height:auto;display:block;margin:0 auto 16px}
    .no-access h2{margin:8px 0 6px}
    .no-access p{color:#666;margin:0 0 12px}
  </style>
</head>
<body>
<header>
  <div style="display:flex;align-items:center;gap:12px">
    <img src="/img/logo.png" alt="Logo" style="height:46px">
    <strong>Veterinarska stanica</strong>
  </div>
  <nav>
    <a href="/">Početna</a>
    <a href="/ljubimci">Ljubimci</a>
    <a href="/pregledi">Pregledi</a>
    <a href="/poruke">Poruke</a>
    <a id="navIzvestaji" href="/izvestaji" style="display:none">Izveštaji</a>
  </nav>
  <div id="userBox"><span id="userInfo"></span>
    <button id="btnLogout" style="display:none;margin-left:8px">Odjava</button>
  </div>
</header>

<div class="wrap">
  <h1>📅 Pregledi</h1>
  <div id="msg" class="muted" style="margin:8px 0 16px 0"></div>

  <div id="noAccessPregledi" class="no-access">
    <img src="/img/tuzna.png" alt="Nema pristup">
    <h2>Morate biti prijavljeni</h2>
    <p>Prijavite se da biste videli svoje preglede.</p>
    <a class="btn" href="/prijava">Prijava</a>
  </div>

  <div id="privPregledi" style="display:none">

    <div id="adminPanel" class="card" style="display:none">
      <div class="row">
        <label>Datum: <input id="inpDate" type="date"></label>
        <label>Veterinar ID: <input id="inpVetId" type="number" style="width:120px"></label>
        <button id="btnPoDanu">Prikaži za dan</button>
        <button id="btnPoVet">Prikaži za veterinara</button>
        <button id="btnSve">Sve (po ulozi)</button>
      </div>
    </div>

    <div id="ownerPanel" class="card" style="display:none">
      <h3 style="margin:0 0 8px 0">➕ Novi pregled</h3>
      <div class="row">
        <label>Ljubimac
          <select id="selLjubimac" style="min-width:220px">
            <option value="">— izaberi ljubimca —</option>
          </select>
        </label>

        <label>Veterinar
          <select id="selVeterinar" style="min-width:220px">
            <option value="">— izaberi veterinara —</option>
          </select>
        </label>

        <label>Usluga
          <input id="npUslugaTxt" placeholder="npr. Vakcinacija, Kontrolni pregled" style="min-width:240px">
        </label>

        <label>Početak
          <input id="npStart" type="datetime-local">
        </label>

        <input id="npNapomena" placeholder="Napomena" style="min-width:240px">
        <button id="btnAdd">Sačuvaj</button>
        <span id="addMsg" class="muted"></span>
      </div>

      <h4 style="margin:16px 0 8px 0">✏️ Izmeni termin</h4>
      <div class="row">
        <label>Pregled ID <input id="edId" type="number" style="width:100px"></label>
        <label>Početak
          <input id="edStart" type="datetime-local">
        </label>
        <input id="edNapomena" placeholder="Napomena" style="min-width:200px">
        <button id="btnEdit">Izmeni</button>
        <span id="editMsg" class="muted"></span>
      </div>

      <h4 style="margin:16px 0 8px 0">🗑 Otkazivanje</h4>
      <div class="row">
        <label>Pregled ID <input id="delId" type="number" style="width:100px"></label>
        <button id="btnDel" class="danger">Otkaži</button>
        <span id="delMsg" class="muted"></span>
      </div>
    </div>

    <div id="vetPanel" class="card" style="display:none">
      <h3 style="margin:0 0 8px 0">✅ Promeni status</h3>
      <div class="row">
        <label>Pregled ID <input id="stId" type="number" style="width:100px"></label>
        <select id="stVal">
          <option>ZAKAZAN</option>
          <option>POTVRĐEN</option>
          <option>OBAVLJEN</option>
          <option>OTKAZAN</option>
        </select>
        <button id="btnStatus">Primeni</button>
        <span id="stMsg" class="muted"></span>
      </div>

      <h3 style="margin:16px 0 8px 0">🩺 Medicinski zapis</h3>
      <div class="row">
        <label>Ljubimac
          <select id="mzLjubimacSelect" style="min-width:220px"></select>
        </label>
        <label>Dijagnoza <input id="mzDijagnoza" placeholder="Obavezno" style="min-width:200px"></label>
        <label>Terapija <input id="mzTerapija" placeholder="Opcionalno" style="min-width:200px"></label>
        <button id="btnZapisi">Sačuvaj zapis</button>
        <span id="mzMsg" class="muted"></span>
      </div>
    </div>

    <h2 style="margin-top:20px">📋 Pregledi</h2>
    <table id="tbl">
      <thead>
        <tr>
          <th>ID</th>
          <th>Ljubimac</th>
          <th>Veterinar</th>
          <th>Usluga</th>
          <th>Početak</th>
          <th>Kraj</th>
          <th>Status</th>
          <th>Napomena</th>
        </tr>
      </thead>
      <tbody id="rows">
        <tr><td colspan="8">Učitavam…</td></tr>
      </tbody>
    </table>

    <div id="vetZapisiCard" class="card" style="display:none">
      <h3 style="margin:0 0 8px 0">🩺 Medicinski zapisi</h3>
      <div id="mzInfo" class="muted" style="margin-bottom:8px">Učitavam…</div>
      <table style="width:100%;border-collapse:collapse;background:#fff;border:1px solid #e6e6e6">
        <thead>
          <tr style="background:#f2f4f7">
            <th>Datum</th>
            <th>Ljubimac</th>
            <th>Dijagnoza</th>
            <th>Terapija</th>
            <th>Veterinar</th>
          </tr>
        </thead>
        <tbody id="mzRows">
          <tr><td colspan="5">Učitavam…</td></tr>
        </tbody>
      </table>
    </div>

  </div>
</div>

<script src="/js/auth.js"></script>
<script>
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', paintUserInfoHeader);
  } else {
    paintUserInfoHeader();
  }
</script>

<script>
(async function loadDropdownForVet(){
  const sel = document.getElementById('mzLjubimacSelect');
  if(!sel) return;
  sel.innerHTML='<option value="">— izaberi ljubimca —</option>';
  try{
    const data = await fetchJSON('/api/medicinski-zapisi/moji-ljubimci-za-izvestaj',{headers:authHeader()},'mzMsg',null,{appendServerText:false});
    if(Array.isArray(data)){
      sel.innerHTML='<option value="">— izaberi ljubimca —</option>' +
        data.map(x=>`<option value="${x.pregledId}">${x.ljubimacIme} (${x.vlasnik||''})</option>`).join('');
    }
  }catch(_){ sel.innerHTML='<option>Greška pri učitavanju</option>'; }
})();

document.getElementById('btnZapisi')?.addEventListener('click', async ()=>{
  const out = document.getElementById('mzMsg');
  const pregledId = Number(document.getElementById('mzLjubimacSelect').value);
  const dijagnoza = (document.getElementById('mzDijagnoza').value||'').trim();
  const terapija = (document.getElementById('mzTerapija').value||'').trim();
  if(!pregledId || !dijagnoza){
    out.textContent='Izaberite ljubimca i unesite dijagnozu.'; return;
  }
  try{
    await fetchJSON('/api/medicinski-zapisi',{
      method:'POST',
      headers:{...authHeader(),'Content-Type':'application/json'},
      body:JSON.stringify({pregledId,dijagnoza,terapija})
    },'mzMsg',null,{appendServerText:false});
    out.textContent='Zapis sačuvan ✅';
    await loadZapisi();
  }catch(e){ out.textContent=e.message||'Greška pri čuvanju.'; }
});
</script>
</body>
</html>
