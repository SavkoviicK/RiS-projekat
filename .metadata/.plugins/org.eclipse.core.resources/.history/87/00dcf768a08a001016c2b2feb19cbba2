<%@ page contentType="text/html; charset=UTF-8" %>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c" %>
<%@ taglib uri="http://java.sun.com/jsp/jstl/fmt" prefix="fmt" %>
<!DOCTYPE html>
<html lang="sr">
<head>
    <meta charset="UTF-8">
    <title>Chat</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; background: #f4f6f9; }
        .container { display: flex; height: 100vh; }
        .sidebar { width: 250px; background: #2c3e50; color: #ecf0f1; padding: 15px; }
        .sidebar h2 { margin-top: 0; font-size: 18px; }
        .sidebar a { display: block; color: #ecf0f1; padding: 8px; text-decoration: none; border-radius: 5px; }
        .sidebar a:hover { background: #34495e; }
        .chat { flex: 1; display: flex; flex-direction: column; }
        .chat-header { background: #3498db; color: white; padding: 15px; font-weight: bold; }
        .messages { flex: 1; overflow-y: auto; padding: 15px; background: #fff; }
        .msg { margin: 10px 0; max-width: 60%; padding: 10px; border-radius: 10px; }
        .me { background: #d1f0ff; margin-left: auto; text-align: right; }
        .them { background: #ecf0f1; margin-right: auto; }
        .time { font-size: 11px; color: #7f8c8d; margin-top: 4px; }
        .input-area { display: flex; padding: 10px; background: #eee; }
        .input-area input { flex: 1; padding: 10px; border: 1px solid #ccc; border-radius: 5px; }
        .input-area button { margin-left: 10px; padding: 10px 15px; background: #3498db; border: none; color: white; border-radius: 5px; cursor: pointer; }
        .input-area button:hover { background: #2980b9; }
    </style>
</head>
<body>

<div class="container">
    <!-- Sidebar sa prijateljima -->
    <div class="sidebar">
        <h2>Prijatelji</h2>
        <c:forEach var="f" items="${friends}">
            <a href="${pageContext.request.contextPath}/chat?friendId=${f.id}">
                ${f.ime}
            </a>
        </c:forEach>
        <c:if test="${empty friends}">
            <p>JoÅ¡ nemaÅ¡ prijatelja.</p>
        </c:if>
    </div>

    <!-- Chat deo -->
    <div class="chat">
        <div class="chat-header">
            <c:choose>
                <c:when test="${not empty activeFriend}">
                    Razgovor sa ${activeFriend.ime}
                </c:when>
                <c:otherwise>
                    Izaberi prijatelja sa liste
                </c:otherwise>
            </c:choose>
        </div>

        <div class="messages" id="messages">
            <c:forEach var="m" items="${messages}">
                <c:set var="isMe" value="${m.sender.id == currentUser.id}" />
                <div class="msg ${isMe ? 'me' : 'them'}">
                    <div>${m.content}</div>
                    <div class="time">
                        <fmt:formatDate value="${m.sentAt}" pattern="dd.MM.yyyy HH:mm" />
                    </div>
                </div>
            </c:forEach>
            <c:if test="${empty messages and not empty activeFriend}">
                <p>Nema poruka â€“ napiÅ¡i prvu ðŸ™‚</p>
            </c:if>
        </div>

        <c:if test="${not empty activeFriend}">
            <form method="post" action="${pageContext.request.contextPath}/chat/send" class="input-area">
                <input type="hidden" name="friendId" value="${activeFriend.id}" />
                <input type="text" name="content" placeholder="Unesite poruku..." required />
                <button type="submit">PoÅ¡alji</button>
            </form>
        </c:if>
    </div>
</div>

<script>
    const box = document.getElementById("messages");
    if (box) { box.scrollTop = box.scrollHeight; }
</script>

</body>
</html>
