<%@ page contentType="text/html; charset=UTF-8" %>
<!DOCTYPE html>
<html lang="sr">
<head>
  <meta charset="UTF-8">
  <title>Pregledi</title>
  <style>
    body{font-family:system-ui,Arial;margin:0;background:#f7f9fb}
    header{display:flex;align-items:center;justify-content:space-between;gap:16px;
           padding:16px 24px;background:#fff;border-bottom:1px solid #e6e6e6}
    nav a{margin-right:12px;text-decoration:none;color:#0b5ed7}
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
    table{width:100%;border-collapse:collapse;background:#fff;border:1px solid #e6e6e6}
    th,td{padding:10px;border-top:1px solid #eee;text-align:left;vertical-align:top}
    thead tr{background:#f2f4f7}
    .muted{color:#6b7280}
    button{background:#0b5ed7;color:#fff;border:none;border-radius:8px;padding:8px 12px;cursor:pointer}
    button:disabled{opacity:.6;cursor:not-allowed}
    input{padding:6px 8px;border:1px solid #dcdcdc;border-radius:8px}
  </style>
</head>
<body>
<header>
  <div style="display:flex;align-items:center;gap:12px">
    <img src="/img/logo.png" alt="Logo" style="height:46px">
    <strong>Veterinarska stanica</strong>
  </div>
  <nav>
    <a href="/">Poƒçetna</a>
    <a href="/ljubimci">Ljubimci</a>
    <a href="/pregledi">Pregledi</a>
    <a href="/prijava">Prijava</a>
  </nav>
  <div id="userBox"><span id="userInfo"></span>
    <button id="btnLogout" style="display:none;margin-left:8px">Odjava</button>
  </div>
</header>

<div class="wrap">
  <h1>üìÖ Pregledi</h1>
  <div id="msg" class="muted" style="margin:8px 0 16px 0"></div>

  <!-- Filteri -->
  <div style="margin:12px 0; display:flex; gap:12px; align-items:center; flex-wrap:wrap">
    <label>Datum: <input id="inpDate" type="date"></label>
    <label>Veterinar ID: <input id="inpVetId" type="number" style="width:120px"></label>
    <button id="btnPoDanu">Prika≈æi za dan</button>
    <button id="btnPoVet">Prika≈æi za veterinara</button>
    <button id="btnSve">Sve (po ulozi)</button>
  </div>

  <table id="tbl">
    <thead>
      <tr>
        <th>ID</th>
        <th>Ljubimac</th>
        <th>Veterinar</th>
        <th>Usluga</th>
        <th>Poƒçetak</th>
        <th>Kraj</th>
        <th>Status</th>
        <th>Napomena</th>
      </tr>
    </thead>
    <tbody id="rows">
      <tr><td colspan="8">Uƒçitavam‚Ä¶</td></tr>
    </tbody>
  </table>
</div>

<!-- auth helperi -->
<script src="/js/auth.js"></script>
<script>
// Formatiranje datuma (ISO -> lokalni string)
function fmt(iso){
  if(!iso) return '';
  const d=new Date(iso);
  if(Number.isNaN(d.getTime())) return iso;
  return d.toLocaleString();
}

// Render zajedniƒçka funkcija
async function fetchAndRender(url){
  const msg=document.getElementById('msg');
  const rows=document.getElementById('rows');

  // provera login-a
  if(!localStorage.getItem('jwt')){
    msg.innerHTML='Niste prijavljeni. <a href="/prijava">Prijavite se</a> da vidite preglede.';
    rows.innerHTML='';
    return;
  }

  rows.innerHTML='<tr><td colspan="8">Uƒçitavam‚Ä¶</td></tr>';
  try{
    const res = await fetch(url, { headers: authHeader() });
    if (res.status===401 || res.status===403){
      rows.innerHTML='';
      msg.textContent='Nemate dozvolu (401/403).';
      return;
    }
    if(!res.ok) throw new Error('Gre≈°ka ' + res.status);

    const data = await res.json();
    if(!Array.isArray(data) || data.length===0){
      rows.innerHTML='<tr><td colspan="8">Nema termina.</td></tr>';
      msg.textContent='';
      return;
    }

    let html='';
    for(const p of data){
      html += '<tr>'
        + '<td>' + (p.id||'') + '</td>'
        + '<td>' + (p.ljubimacIme||'') + '</td>'
        + '<td>' + (p.veterinarIme||'') + '</td>'
        + '<td>' + (p.uslugaNaziv||'') + '</td>'
        + '<td>' + fmt(p.datumPocetka) + '</td>'
        + '<td>' + fmt(p.datumZavrsetka) + '</td>'
        + '<td>' + (p.status||'') + '</td>'
        + '<td>' + (p.napomena||'') + '</td>'
        + '</tr>';
    }
    rows.innerHTML = html;
    msg.textContent='';
  }catch(err){
    rows.innerHTML='';
    msg.textContent='Do≈°lo je do gre≈°ke: ' + err.message;
  }
}

// Po difoltu ‚Äì ‚Äúsve po ulozi‚Äù
async function loadAppointments(){
  await fetchAndRender('/api/pregledi');
}

// Header login/odjava
(function(){
  function paint(){
    const info=document.getElementById('userInfo');
    const btn=document.getElementById('btnLogout');
    const t=localStorage.getItem('jwt');
    if(t){
      const roles = JSON.parse(localStorage.getItem('roles')||'[]');
      info.textContent = 'Prijavljen' + (roles.length?(' ('+roles.map(r=>r.authority).join(', ')+')'):'');
      btn.style.display='inline-block';
      btn.onclick=()=>{ logout(); location.href='/'; };
    }else{
      info.innerHTML='<a href="/prijava">Prijavi se</a>';
      btn.style.display='none';
    }
  }

  window.addEventListener('load', ()=>{
    paint();
    loadAppointments();

    // Dugmad filtera
    document.getElementById('btnSve').onclick = ()=> fetchAndRender('/api/pregledi');

    document.getElementById('btnPoDanu').onclick = ()=>{
      const d = document.getElementById('inpDate').value;
      if(!d){ alert('Izaberi datum.'); return; }
      fetchAndRender('/api/pregledi/po-danu?date='+encodeURIComponent(d));
    };

    document.getElementById('btnPoVet').onclick = ()=>{
      const id = (document.getElementById('inpVetId').value||'').trim();
      if(!id){ alert('Unesi veterinarId.'); return; }
      const d  = document.getElementById('inpDate').value;
      const q  = d ? ('&date='+encodeURIComponent(d)) : '';
      fetchAndRender('/api/pregledi/po-veterinaru?veterinarId='+encodeURIComponent(id)+q);
    };
  });
})();
</script>
</body>
</html>
